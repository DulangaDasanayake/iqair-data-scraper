<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AQ Data File Downloader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        .file-list {
            list-style-type: none;
            padding: 0;
        }
        .file-list li {
            margin: 10px 0;
        }
        .btn {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Download AQI Data & Map Files</h1>
    <h2>Maps</h2>
    <ul id="map-files" class="file-list"></ul>
    <h2>Charts</h2>
    <ul id="chart-files" class="file-list"></ul>
    <button class="btn" id="download-btn">Download Selected Files</button>

    <script>
        const mapFilesList = document.getElementById('map-files');
        const chartFilesList = document.getElementById('chart-files');
        const downloadBtn = document.getElementById('download-btn');

        // GitHub Repo Details
        const repoOwner = 'DulangaDasanayake'; // Your GitHub username
        const repoName = 'iqair-data-scraper'; // Your repo name
        const branchName = 'main'; // Branch where files are stored

        // Function to fetch files from GitHub repo
        async function fetchFiles(folderPath) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folderPath}?ref=${branchName}`;
            const response = await fetch(url);
            const data = await response.json();
            return data;
        }

        // Populate the file lists
        async function populateFileList() {
            try {
                // Show the loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.innerText = 'Loading files...';
                document.body.appendChild(loadingIndicator);

                const mapFiles = await fetchFiles('maps');
                const chartFiles = await fetchFiles('charts');

                // Remove loading indicator once files are fetched
                document.body.removeChild(loadingIndicator);

                // Populate maps list
                mapFiles.forEach(file => {
                    const fileUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branchName}/maps/${file.name}`;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <input type="checkbox" value="${fileUrl}" id="map-${file.name}">
                        <label for="map-${file.name}">${file.name}</label>
                    `;
                    mapFilesList.appendChild(listItem);
                });

                // Populate charts list
                chartFiles.forEach(file => {
                    const fileUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branchName}/charts/${file.name}`;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <input type="checkbox" value="${fileUrl}" id="chart-${file.name}">
                        <label for="chart-${file.name}">${file.name}</label>
                    `;
                    chartFilesList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching files:', error);
            }
        }

        // Function to force download files
        async function forceDownload(fileUrl, fileName) {
            try {
                const response = await fetch(fileUrl);
                const blob = await response.blob();  // Convert response to blob
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName; // Set proper filename
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Download failed:', error);
            }
        }

        // Handle file download when the button is clicked
        downloadBtn.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one file to download.');
                return;
            }

            checkboxes.forEach(checkbox => {
                const fileUrl = checkbox.value;
                const fileName = fileUrl.split('/').pop();
                forceDownload(fileUrl, fileName);
            });
        });

        // Initialize file list on page load
        window.onload = populateFileList;
    </script>
</body>
</html>
